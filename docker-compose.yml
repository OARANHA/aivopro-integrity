# =====================================================
# 28FACIL API - Stack com Traefik SSL
# Deploy DEPOIS do traefik-stack.yml
# =====================================================

version: '3.8'

services:
  # =====================================================
  # MYSQL - Banco de Dados
  # =====================================================
  mysql:
    image: mysql:8.0
    container_name: 28facil-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-senha_forte_123}
      MYSQL_DATABASE: ${DB_DATABASE:-28facil_api}
      MYSQL_USER: ${DB_USERNAME:-28facil}
      MYSQL_PASSWORD: ${DB_PASSWORD:-senha_forte_123}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - 28facil-internal
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # API SERVER - 28Facil
  # =====================================================
  api-server:
    image: php:8.2-apache
    container_name: 28facil-api
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-28facil_api}
      DB_USERNAME: ${DB_USERNAME:-28facil}
      DB_PASSWORD: ${DB_PASSWORD:-senha_forte_123}
      JWT_SECRET: ${JWT_SECRET:-mude_isso_em_producao_para_chave_segura}
    networks:
      - 28facil-internal
      - traefik-public
    depends_on:
      mysql:
        condition: service_healthy
    entrypoint: /bin/bash
    command:
      - -c
      - |
        docker-php-ext-install pdo pdo_mysql mysqli
        a2enmod rewrite
        mkdir -p /var/www/html/public
        echo '<?php header("Content-Type: application/json"); echo json_encode(["status" => "success", "message" => "28Facil API Server is running!", "timestamp" => date("Y-m-d H:i:s"), "version" => "1.0.0", "php_version" => phpversion(), "database" => ["host" => getenv("DB_HOST"), "database" => getenv("DB_DATABASE"), "status" => "configured"]], JSON_PRETTY_PRINT);' > /var/www/html/public/index.php
        sed -i 's|/var/www/html|/var/www/html/public|g' /etc/apache2/sites-available/000-default.conf
        apache2-foreground
    
    labels:
      # Habilitar Traefik
      - "traefik.enable=true"
      
      # Rede que o Traefik vai usar
      - "traefik.docker.network=traefik-public"
      
      # Roteamento HTTP -> HTTPS (redirect automático)
      - "traefik.http.routers.api-http.rule=Host(`api.28facil.com.br`)"
      - "traefik.http.routers.api-http.entrypoints=web"
      - "traefik.http.routers.api-http.middlewares=redirect-to-https"
      
      # Roteamento HTTPS
      - "traefik.http.routers.api-https.rule=Host(`api.28facil.com.br`)"
      - "traefik.http.routers.api-https.entrypoints=websecure"
      - "traefik.http.routers.api-https.tls=true"
      - "traefik.http.routers.api-https.tls.certresolver=letsencrypt"
      
      # Serviço (porta interna do container)
      - "traefik.http.services.api-service.loadbalancer.server.port=80"
      
      # Middleware de redirect
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

networks:
  traefik-public:
    external: true
  28facil-internal:
    driver: bridge

volumes:
  mysql-data:
