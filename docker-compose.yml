# =====================================================
# 28FÁCIL API - Stack para Portainer
# Deploy direto do GitHub via Portainer
# =====================================================

version: '3.8'

services:
  # =====================================================
  # MYSQL - Banco de Dados
  # =====================================================
  mysql:
    image: mysql:8.0
    container_name: 28facil-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-senha_forte_123}
      MYSQL_DATABASE: ${DB_DATABASE:-28facil_api}
      MYSQL_USER: ${DB_USERNAME:-28facil}
      MYSQL_PASSWORD: ${DB_PASSWORD:-senha_forte_123}
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - 28facil-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # API SERVER - 28Fácil
  # =====================================================
  api-server:
    image: php:8.2-apache
    container_name: 28facil-api
    restart: unless-stopped
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-28facil_api}
      DB_USERNAME: ${DB_USERNAME:-28facil}
      DB_PASSWORD: ${DB_PASSWORD:-senha_forte_123}
      JWT_SECRET: ${JWT_SECRET:-mude_isso_em_producao_para_chave_segura}
    ports:
      - "8080:80"
    networks:
      - 28facil-network
    depends_on:
      mysql:
        condition: service_healthy
    command: |
      bash -c "
        # Instalar extensões PHP necessárias
        docker-php-ext-install pdo pdo_mysql mysqli
        
        # Ativar mod_rewrite do Apache
        a2enmod rewrite
        
        # Criar diretório public se não existir
        mkdir -p /var/www/html/public
        
        # Criar index.php básico para teste
        if [ ! -f /var/www/html/public/index.php ]; then
          cat > /var/www/html/public/index.php << 'EOF'
<?php
header('Content-Type: application/json');

echo json_encode([
    'status' => 'success',
    'message' => '28Fácil API Server is running!',
    'timestamp' => date('Y-m-d H:i:s'),
    'version' => '1.0.0',
    'php_version' => phpversion(),
    'database' => [
        'host' => getenv('DB_HOST'),
        'database' => getenv('DB_DATABASE'),
        'status' => 'configured'
    ]
], JSON_PRETTY_PRINT);
EOF
        fi
        
        # Configurar Apache DocumentRoot
        sed -i 's|/var/www/html|/var/www/html/public|g' /etc/apache2/sites-available/000-default.conf
        
        # Restart Apache
        apache2-foreground
      "

networks:
  28facil-network:
    driver: bridge

volumes:
  mysql-data:
