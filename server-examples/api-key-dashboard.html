<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar API Keys - 28F√°cil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .key-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .key-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .key-card.inactive {
            opacity: 0.6;
            border: 2px dashed #e2e8f0;
        }
        
        .key-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .key-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .key-prefix {
            font-family: 'Courier New', monospace;
            background: #f7fafc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            color: #667eea;
        }
        
        .key-info {
            margin: 12px 0;
        }
        
        .key-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f7fafc;
        }
        
        .key-info-label {
            color: #718096;
            font-size: 14px;
        }
        
        .key-info-value {
            color: #2d3748;
            font-weight: 500;
            font-size: 14px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .key-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
        
        .key-actions button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 24px;
        }
        
        .modal-header h2 {
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .permission-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .permission-checkbox:hover {
            background: #f7fafc;
        }
        
        .permission-checkbox input {
            margin-right: 8px;
            width: auto;
        }
        
        .success-box {
            background: #c6f6d5;
            border: 2px solid #9ae6b4;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success-box .api-key-display {
            background: white;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            word-break: break-all;
            margin: 12px 0;
            border: 2px dashed #667eea;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-warning {
            background: #fef5e7;
            border: 2px solid #f9e79f;
            color: #7d6608;
        }
        
        @media (max-width: 768px) {
            .keys-grid {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîë Gerenciar API Keys</h1>
            <p>Crie e gerencie suas chaves de API para integra√ß√µes com o sistema 28F√°cil</p>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="openCreateModal()">
                + Nova API Key
            </button>
            <button class="btn btn-secondary" onclick="loadKeys()">
                üîÑ Atualizar
            </button>
        </div>

        <div id="keysContainer" class="keys-grid">
            <!-- API Keys ser√£o carregadas aqui -->
        </div>
    </div>

    <!-- Modal de Criar API Key -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Criar Nova API Key</h2>
                <p style="color: #666;">Preencha os dados para gerar uma nova chave de API</p>
            </div>

            <form id="createForm">
                <div class="form-group">
                    <label>Nome da Key *</label>
                    <input type="text" name="name" required placeholder="Ex: Produ√ß√£o, Desenvolvimento, Integra√ß√£o WhatsApp">
                </div>

                <div class="form-group">
                    <label>Descri√ß√£o (opcional)</label>
                    <textarea name="description" rows="3" placeholder="Descreva para que esta key ser√° usada"></textarea>
                </div>

                <div class="form-group">
                    <label>Permiss√µes</label>
                    <div class="permissions-grid">
                        <label class="permission-checkbox">
                            <input type="checkbox" name="permissions" value="read" checked>
                            <span>üëÅÔ∏è Leitura (Read)</span>
                        </label>
                        <label class="permission-checkbox">
                            <input type="checkbox" name="permissions" value="write">
                            <span>‚úèÔ∏è Escrita (Write)</span>
                        </label>
                        <label class="permission-checkbox">
                            <input type="checkbox" name="permissions" value="delete">
                            <span>üóëÔ∏è Deletar (Delete)</span>
                        </label>
                        <label class="permission-checkbox">
                            <input type="checkbox" name="permissions" value="admin">
                            <span>üîë Admin</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Limite de Requisi√ß√µes/Hora</label>
                    <input type="number" name="rate_limit" value="1000" min="1" max="10000">
                </div>

                <div class="form-group">
                    <label>Expira em (opcional)</label>
                    <input type="date" name="expires_at">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Criar API Key</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()" style="flex: 1;">Cancelar</button>
                </div>
            </form>

            <div id="successBox" class="success-box" style="display: none;">
                <h3 style="color: #22543d; margin-bottom: 12px;">‚úÖ API Key Criada com Sucesso!</h3>
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta √© a √∫nica vez que a key completa ser√° exibida. Copie e guarde em local seguro!
                </div>
                <div class="api-key-display" id="newApiKey"></div>
                <button class="btn btn-primary" style="width: 100%;" onclick="copyApiKey()">üìã Copiar API Key</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://api.28facil.com.br';
        let authToken = null; // Definir o token de autentica√ß√£o do usu√°rio

        // Carregar API Keys
        async function loadKeys() {
            try {
                const response = await fetch(`${API_URL}/api/keys`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    renderKeys(data.data);
                } else {
                    alert('Erro ao carregar API keys');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        // Renderizar keys na tela
        function renderKeys(keys) {
            const container = document.getElementById('keysContainer');

            if (keys.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: white; border-radius: 12px;">
                        <h3 style="color: #666; margin-bottom: 12px;">üîë Nenhuma API Key encontrada</h3>
                        <p style="color: #999;">Clique em "Nova API Key" para criar sua primeira chave</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = keys.map(key => `
                <div class="key-card ${!key.is_active ? 'inactive' : ''}">
                    <div class="key-header">
                        <div>
                            <div class="key-name">${key.name}</div>
                            <div class="key-prefix">${key.prefix}***</div>
                        </div>
                        <span class="badge ${key.is_active ? 'badge-success' : 'badge-danger'}">
                            ${key.is_active ? '‚úÖ Ativa' : '‚ùå Revogada'}
                        </span>
                    </div>

                    ${key.description ? `<p style="color: #666; font-size: 14px; margin: 12px 0;">${key.description}</p>` : ''}

                    <div class="key-info">
                        <div class="key-info-item">
                            <span class="key-info-label">Permiss√µes:</span>
                            <span class="key-info-value">${key.permissions.join(', ')}</span>
                        </div>
                        <div class="key-info-item">
                            <span class="key-info-label">Limite/hora:</span>
                            <span class="key-info-value">${key.rate_limit}</span>
                        </div>
                        <div class="key-info-item">
                            <span class="key-info-label">Total de usos:</span>
                            <span class="key-info-value">${key.usage_count || 0}</span>
                        </div>
                        <div class="key-info-item">
                            <span class="key-info-label">√öltimo uso:</span>
                            <span class="key-info-value">${key.last_used_at ? new Date(key.last_used_at).toLocaleString('pt-BR') : 'Nunca'}</span>
                        </div>
                        <div class="key-info-item">
                            <span class="key-info-label">Criada em:</span>
                            <span class="key-info-value">${new Date(key.created_at).toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>

                    ${key.is_active ? `
                        <div class="key-actions">
                            <button class="btn btn-danger" onclick="revokeKey(${key.id}, '${key.name}')">
                                üö´ Revogar
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Criar nova API Key
        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const permissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked'))
                .map(cb => cb.value);

            const data = {
                name: formData.get('name'),
                description: formData.get('description') || null,
                permissions: permissions,
                rate_limit: parseInt(formData.get('rate_limit')),
                expires_at: formData.get('expires_at') || null
            };

            try {
                const response = await fetch(`${API_URL}/api/keys`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // Mostrar a key gerada
                    document.getElementById('newApiKey').textContent = result.data.key;
                    document.getElementById('successBox').style.display = 'block';
                    document.getElementById('createForm').style.display = 'none';

                    // Recarregar lista
                    setTimeout(() => loadKeys(), 2000);
                } else {
                    alert('Erro ao criar API key: ' + result.error);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        });

        // Revogar API Key
        async function revokeKey(keyId, keyName) {
            if (!confirm(`Tem certeza que deseja revogar a API Key "${keyName}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }

            const reason = prompt('Motivo da revoga√ß√£o (opcional):');

            try {
                const response = await fetch(`${API_URL}/api/keys/${keyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ reason: reason || 'Revogada pelo usu√°rio' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ API Key revogada com sucesso!');
                    loadKeys();
                } else {
                    alert('Erro ao revogar: ' + result.error);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        // Copiar API Key
        function copyApiKey() {
            const keyText = document.getElementById('newApiKey').textContent;
            navigator.clipboard.writeText(keyText).then(() => {
                alert('‚úÖ API Key copiada para a √°rea de transfer√™ncia!');
            });
        }

        // Controle do modal
        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
            document.getElementById('createForm').reset();
            document.getElementById('successBox').style.display = 'none';
            document.getElementById('createForm').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
        }

        // Carregar keys ao iniciar
        // loadKeys(); // Descomente quando tiver autentica√ß√£o configurada

        // DEMO: Simular dados para teste visual
        renderKeys([
            {
                id: 1,
                prefix: '28fc_a1b2c3d4',
                name: 'Produ√ß√£o',
                description: 'Key principal de produ√ß√£o',
                permissions: ['read', 'write'],
                is_active: true,
                rate_limit: 1000,
                usage_count: 15234,
                last_used_at: new Date().toISOString(),
                created_at: '2026-01-01T10:00:00'
            },
            {
                id: 2,
                prefix: '28fc_xyz98765',
                name: 'Desenvolvimento',
                permissions: ['read'],
                is_active: true,
                rate_limit: 500,
                usage_count: 432,
                last_used_at: new Date().toISOString(),
                created_at: '2026-01-15T14:30:00'
            },
            {
                id: 3,
                prefix: '28fc_old12345',
                name: 'Key Antiga',
                permissions: ['read', 'write', 'delete'],
                is_active: false,
                rate_limit: 1000,
                usage_count: 50000,
                created_at: '2025-06-01T08:00:00'
            }
        ]);
    </script>
</body>
</html>